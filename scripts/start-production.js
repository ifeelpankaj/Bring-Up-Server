#!/usr/bin/env node
/**
 * Production startup script
 * 1. Generates production.env from .env file
 * 2. Runs the production server
 */

const { spawn } = require('child_process');
const fs = require('fs');
const path = require('path');

const ENV_SOURCE = path.join(__dirname, '../.env');
const ENV_TARGET = path.join(
  __dirname,
  '../libs/config/src/env/production.env',
);

// Parse .env file content
function parseEnvFile(filePath) {
  if (!fs.existsSync(filePath)) {
    console.error(`Error: Source env file not found: ${filePath}`);
    process.exit(1);
  }

  const content = fs.readFileSync(filePath, 'utf-8');
  const envVars = {};
  const lines = content.split('\n');

  for (const line of lines) {
    const trimmed = line.trim();
    if (!trimmed || trimmed.startsWith('#')) continue;

    const match = trimmed.match(/^([A-Z_][A-Z0-9_]*)=(.*)$/);
    if (match) {
      const key = match[1];
      let value = match[2];

      if (
        (value.startsWith('"') && value.endsWith('"')) ||
        (value.startsWith("'") && value.endsWith("'"))
      ) {
        value = value.slice(1, -1);
      }

      envVars[key] = value;
    }
  }

  return envVars;
}

// Generate production.env
function generateProductionEnv() {
  console.log('ðŸ“ Reading environment from:', ENV_SOURCE);

  const envVars = parseEnvFile(ENV_SOURCE);
  const productionVars = { ...envVars, NODE_ENV: 'production' };

  let content = '# Production Environment Variables\n';
  content += '# Auto-generated by start-production.js\n';
  content += `# Generated at: ${new Date().toISOString()}\n\n`;

  for (const [key, value] of Object.entries(productionVars)) {
    content += `${key}=${value}\n`;
  }

  fs.writeFileSync(ENV_TARGET, content, 'utf-8');
  console.log('âœ… Production environment generated:', ENV_TARGET);

  return productionVars;
}

// Start the server
function startServer() {
  console.log('ðŸš€ Starting production server...\n');

  const mainJs = path.join(__dirname, '../apps/api/dist/main.js');

  if (!fs.existsSync(mainJs)) {
    console.error('âŒ Error: Build not found. Run "npm run build" first.');
    process.exit(1);
  }

  const server = spawn('node', [mainJs], {
    stdio: 'inherit',
    env: { ...process.env, NODE_ENV: 'production' },
    cwd: path.join(__dirname, '..'),
  });

  server.on('error', (err) => {
    console.error('Failed to start server:', err);
    process.exit(1);
  });

  server.on('close', (code) => {
    process.exit(code || 0);
  });
}

// Main
function main() {
  console.log('\n=== Bringup Production Startup ===\n');
  generateProductionEnv();
  console.log('');
  startServer();
}

main();
