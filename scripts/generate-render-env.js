#!/usr/bin/env node
/**
 * Script to read environment variables from .env file
 * and generate output for Render deployment
 *
 * Usage:
 *   node scripts/generate-render-env.js           # Output to console (for Render dashboard)
 *   node scripts/generate-render-env.js --file   # Write to production.env
 */

const fs = require('fs');
const path = require('path');

const ENV_SOURCE = path.join(__dirname, '../.env');
const ENV_TARGET = path.join(
  __dirname,
  '../libs/config/src/env/production.env',
);

// Parse .env file content
function parseEnvFile(filePath) {
  if (!fs.existsSync(filePath)) {
    console.error(`Error: File not found: ${filePath}`);
    process.exit(1);
  }

  const content = fs.readFileSync(filePath, 'utf-8');
  const envVars = {};

  const lines = content.split('\n');

  for (const line of lines) {
    const trimmed = line.trim();

    // Skip empty lines and comments
    if (!trimmed || trimmed.startsWith('#')) continue;

    // Match KEY=VALUE pattern
    const match = trimmed.match(/^([A-Z_][A-Z0-9_]*)=(.*)$/);
    if (match) {
      const key = match[1];
      let value = match[2];

      // Remove surrounding quotes if present
      if (
        (value.startsWith('"') && value.endsWith('"')) ||
        (value.startsWith("'") && value.endsWith("'"))
      ) {
        value = value.slice(1, -1);
      }

      envVars[key] = value;
    }
  }

  return envVars;
}

// Generate Render-compatible output
function generateRenderOutput(envVars) {
  console.log('\n=== Render Environment Variables ===\n');
  console.log(
    'Copy these to your Render dashboard (Settings > Environment):\n',
  );
  console.log('-----------------------------------\n');

  // Override NODE_ENV for production
  const productionVars = { ...envVars, NODE_ENV: 'production' };

  for (const [key, value] of Object.entries(productionVars)) {
    console.log(`${key}=${value}`);
  }

  console.log('\n-----------------------------------\n');
  console.log('Or use the Render Blueprint format (render.yaml):\n');

  console.log('envVars:');
  for (const [key, value] of Object.entries(productionVars)) {
    // Mask sensitive values in example output
    const isSensitive =
      key.includes('KEY') || key.includes('SECRET') || key.includes('PASSWORD');
    const displayValue = isSensitive ? '<your-secret-value>' : value;
    console.log(`  - key: ${key}`);
    console.log(`    value: ${displayValue}`);
  }
}

// Write to production.env file
function writeToProductionEnv(envVars) {
  const productionVars = { ...envVars, NODE_ENV: 'production' };

  let content = '# Production Environment Variables\n';
  content += '# Generated by generate-render-env.js\n';
  content += `# Generated at: ${new Date().toISOString()}\n\n`;

  for (const [key, value] of Object.entries(productionVars)) {
    content += `${key}=${value}\n`;
  }

  fs.writeFileSync(ENV_TARGET, content, 'utf-8');
  console.log(`\nâœ“ Production environment written to: ${ENV_TARGET}`);
}

// Main execution
function main() {
  const args = process.argv.slice(2);
  const writeToFile = args.includes('--file');

  console.log('Reading environment variables from:', ENV_SOURCE);

  const envVars = parseEnvFile(ENV_SOURCE);

  if (Object.keys(envVars).length === 0) {
    console.error('Error: No environment variables found in source file');
    process.exit(1);
  }

  console.log(`Found ${Object.keys(envVars).length} environment variables`);

  if (writeToFile) {
    writeToProductionEnv(envVars);
  } else {
    generateRenderOutput(envVars);
  }
}

main();
